# 积木式开发流程总览

```
🧭 模式确认
📍 积木开始
📍 积木执行
📍 AI自行验证
📍 积木完成
📍 用户验证通过后
```

# 开发流程

## 📍 积木开始
🎯 **当前积木**：<名称>
📋 **开发计划**：<简要描述本积木要完成的功能和目标>
📁 **涉及目录**：<列出本积木会修改/创建的主要目录和文件>
⚡ **输入输出**：<明确输入参数、前置条件、输出产物>
✅ **验收方式**：<如何验证、在哪里验证>

## 📍 积木执行
🛠️ **实施步骤**：<具体的开发步骤和实现方案>
📊 **进度更新**：<关键节点的进度汇报>
🐛 **问题记录**：<遇到的问题和解决方案>

## 📍 AI自行验证

- 强制条件：
  1. 所有测试（单测/集成/端到端）必须全部通过（0 失败）。
  2. 前端积木必须使用 Playwright MCP进行自验证；Playwright MCP测试全部通过后方可进入下一步。
  3. ✅ **验收方式**：验证方式里的东西必须自行验证通过


## 📍 积木完成
🔍 **验证地址**：<展示积木效果的链接/路径>
🧪 **测试结果**：<运行测试的结果>

## 📍 用户验证通过后
💾 **代码提交**：<commit信息>
➡️ **后续积木**：<列出下一步可选的积木>
📦 **积木统一登记（all-blocks）**
- 统一登记位置：`docs/all-blocks.md`
- 必填字段：积木名称、唯一ID、域路径、功能摘要、对外契约（接口/DTO/事件/错误码）链接、上游依赖、下游影响、版本、状态、负责人、验收入口、创建/最近验证时间。
- 操作要求：在统一登记文件中追加或更新对应条目，保持版本化与可追溯。

登记模板：
```md

----
## <block-id> - <block-name>
- Domain: `<domain>/<block>/`
- Summary: <一句话功能概述>
- Contracts (exports): <链接列表>
- Upstream Dependencies: [<block-id>]
- Downstream Impact: [<block-id>]
- Version: vX.Y.Z
- Status: active | deprecated | experimental
- Owner: <name/team>
- Acceptance: <link/path>
- CreatedAt: YYYY-MM-DD
- LastVerifiedAt: YYYY-MM-DD
-----
```

---

# 积木解释

* **定义**：代码中最小、可组合、可验收的单元。
* **约束**：每个积木**必须**写清 **输入**（参数/前置/依赖）与 **输出**（产物/可观测结果），并在开始时声明**验收结果展示**：完成后**在哪里/如何**验收（链接/命令/路径/脚本）。
* **实施**：积木**内部实现由 AI 自主制定**（设计/实现/测试方式灵活），但对外以固定格式汇报。



# 分类与目录规范

- 文档类：归档于 `docs/`，每个积木独立子目录维护（示例：`docs/<topic-or-block>/README.md`）。
- 代码类（强制）：积木源码统一归档于 `blocks/<domain>/<block>/`。
  - `blocks/<domain>/<block>/contracts/`：对外契约（接口、类型、DTO、事件、错误码）。
  - `blocks/<domain>/<block>/impl/`：实现代码（仅依赖 contracts 与通用基础库）。
  - `blocks/<domain>/<block>/tests/`：测试（单测/集成/E2E；TDD 先写此处）。
  - `blocks/<domain>/<block>/index.ts`：统一导出层（仅 re-export 对外可见项）。
- 正常项目代码组织不改变：在业务目录中仅通过导包方式引入 `blocks/` 暴露的契约/实现。业务侧只写“胶水逻辑”，不得将业务代码反向放入 `blocks/`。
- 契约优先：实现前先定义对外接口（协议/类型/DTO/事件/错误码），冻结并评审后再实现；实现严格遵循契约。
- 单向依赖：架构/业务 → 契约 → 实现；禁止实现层引用架构层；严禁循环依赖。
- 积木统一登记：在 `docs/all-blocks.md` 以版本/时间维度维护每个积木的元数据与演进记录（名称、域路径、契约、依赖、状态、验收入口、负责人、版本等）。

---

## 强制约束（必须遵守）

1. 源码位置：所有积木代码必须位于 `blocks/`，不得散落在业务目录。
2. 契约冻结：每个积木在实现前必须提交 `contracts/` 并经评审冻结；变更需评审与版本提升。
3. 单向依赖：只能从业务/架构依赖到 `contracts`，实现仅依赖契约与基础库；禁止跨积木私有实现互相引用。
4. 统一导出：每个积木在同层提供 `index.xx` 做 re-export。
5. 规模约束：单文件 ≤ 500 行；单函数 ≤ 80 行。
6. 安全与防御：外部数据校验、异步错误处理、用户输入转义、路径合法性校验。
7. 记录与提交：每个关键步骤写入 dev-log；每个积木完成后提交：`task(<blocks-path>): <动词结果>`。

---

## TDD 强制流程

1. 定义验收：在「积木开始」阶段写明验收入口与判定口径。
2. 先写测试：在 `blocks/<domain>/<block>/tests/` 编写失败的测试（单测/集成/E2E）。
3. 最小实现：在 `impl/` 编写最小通过实现，保持简单。
4. 反复：让测试通过 → 重构 → 测试仍绿。
5. 覆盖率：核心路径必须有正反两类用例；对外契约的边界条件需有测试。
6. 自验证：在「AI自行验证」提供运行命令、验证地址与结果。

---

## 集成方式（胶水层）

- 业务目录通过导入 `blocks/.../index` 使用契约和可见实现，组合出业务流程。
- 胶水层职责：装配、编排、配置；不得侵入/复制 `blocks` 内实现。
- 示例导入约束：
  - 允许：`import { XContract } from 'blocks/<domain>/<block>'`
  - 禁止：`import { InternalImpl } from 'blocks/<domain>/<block>/impl/*'`
  - 允许：在业务层定义 adapter/mapper，但其依赖方向仅指向契约。


# 原则（积木驱动）

1. **积木驱动主线**：所有工作以“积木”为单位推进；先定义积木，再实施与验收。
2. **单积木可验证**：每个积木都要有**清晰验收标准**与**可执行的验证步骤**（自动/手动），完成即验收并记录。
3. **以终为始的验收结果展示**（新增必遵）：开始时就固定验收入口（链接/命令/路径/脚本）与判定口径。
4. **即时验证**：每步完成必须运行对应测试/脚本（单测/集成/端到端），确保正确。
5. **智能记录 + 强制记录**：高信噪比记录决策/问题/方案/发现；**所有步骤**写入 `dev-log/{claude-code-session-ID}/{写入时间}.md`。
   1. 注意不同的 devlog 用 `----`  进行分割
6. **目录即架构；架构可灵活**：以目录体现模块边界，按项目选择合适架构。
7. **代码规模约束**：单文件 ≤ 500 行；单函数 ≤ 80 行。
8. **提交规范**：完成积木即提交：`task(<目录名>): <动词结果>`。
9.  **统一导出**：同层目录提供 `index.xx` 做 re-export，避免 import 路径爆炸。
10. **依赖边界**：禁止循环依赖；功能域仅经公开接口通信。
11. **防御性编程**：外部数据校验；异步错误处理；用户输入转义；文件操作校验路径合法性。
12. **步骤透明**：到达每个关键步骤时须对外标注与说明（便于协作与追踪）。
13. **每个积木完成后提commit**：完成每个积木后提交commit。
14. 先给用户展示验证地址， 再提交代码。 
15. 积木分类与目录：文档类→`docs/`；代码类→`<domain>/<block>/`。
16. 契约优先：先定接口与判定口径，再实现，变更须评审。
17. 单向依赖（架构→契约→实现）：禁止实现层引用架构层。
18. 代码类仍遵循项目最佳架构；积木只通过契约被引用。
19. 积木开发原则： TDD开发+契约优先
20. 积木统一登记：用户验证通过后，更新 `docs/all-blocks.md` 登记与版本记录。


# 模式选择

在开始写代码前，必须确认当前会话的执行模式，并记录在当次 dev-log：

- 全自动模式（Auto）
  - 输入：一个明确的整体任务目标。
  - 行为：自动拆解多个「积木」，按「积木开始 → 积木执行 → AI自行验证 → 积木完成」循环连续推进，过程中不等待用户交互，直到完成整体任务。
  - 停止条件：
    1) 目标完成并产出总体验收入口；
    2) 出现外部依赖/权限/高风险操作需要授权；
    3) 关键不确定性需要用户决策。
  - 交付：每个积木完成即提供「验证地址/测试结果」，最终统一提交代码并更新登记。
  - 记录：全过程将计划、关键决策与结果实时写入 `dev-log/{session-id}/YYYY-MM-DD-*.md`。

- 交互模式（Interactive）
  - 节点把关：每个积木的「积木开始」与「积木完成」两个节点必须等待用户显式确认后才能继续下一步。
  - 在「积木开始」阶段：展示当前积木的名称、开发计划、涉及目录、输入输出、验收方式，待用户确认后执行。
  - 在「积木完成」阶段：展示验证地址与测试结果，待用户确认后提交并进入下一积木。
  - 记录：在每次确认时，将确认结论与时间写入 dev-log。

- 模式切换：仅可在当前积木完整收尾后进行切换，且需在 dev-log 中记录切换理由与时间。
- 默认策略：若未指明，默认采用「交互模式」。