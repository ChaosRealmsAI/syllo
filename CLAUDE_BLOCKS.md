# Claude Code 积木式开发规范 v2.0

## 核心概念
**积木**：最小可验证单元，具有明确的输入、输出和验收标准。

## 执行模式
默认使用**交互模式**，每个积木的开始和完成需用户确认。

## 🎯 核心原则

### 必须遵守
1. **积木驱动主线**：所有工作以积木为单位推进
2. **单积木可验证**：每个积木必须有清晰验收标准
3. **以终为始**：开始时就定义验收入口和判定标准
4. **即时验证**：每步完成必须运行测试
5. **强制记录**：所有步骤写入 dev-log

### 建议遵循
1. **防御性编程**：外部数据校验，异步错误处理
2. **步骤透明**：关键步骤对外标注说明
3. **小步快跑**：积木保持最小化，1-2小时完成

---

## 📋 积木开发流程

### 1️⃣ 积木开始

#### 必须原则
- ✅ 明确写清输入输出
- ✅ 固定验收入口和判定标准
- ✅ 积木代码必须在 `blocks/` 目录
- ✅ 记录到 dev-log

#### 可选原则
- 💡 评估工作量（建议1-2小时内）
- 💡 识别潜在风险

```markdown
## 📍 积木开始
🎯 **积木名称**：[具体名称]
📋 **功能目标**：[一句话说明要实现什么]
📁 **涉及文件**：
- `blocks/[domain]/[block]/` - 积木代码位置
- [其他相关文件路径]
⚡ **输入输出**：
- 输入：[参数/依赖/前置条件]
- 输出：[产物/结果/副作用]
✅ **验收标准**：
- 验收地址：[URL/路径/命令]
- 成功标准：[具体的可观测结果]
```

### 2️⃣ 积木执行

#### 必须原则
- ✅ TDD开发：先写测试再实现
- ✅ 契约优先：先定义接口
- ✅ 单向依赖：业务→契约→实现
- ✅ 统一导出：通过 index.ts
- ✅ 即时验证：每步运行测试

#### 可选原则  
- 💡 代码规模：单文件≤500行，单函数≤80行
- 💡 防御编程：校验外部输入
- 💡 进度透明：关键节点汇报
1. **TDD流程**（必须）：
   - 先在 `blocks/[domain]/[block]/tests/` 写测试
   - 在 `blocks/[domain]/[block]/contracts/` 定义接口
   - 在 `blocks/[domain]/[block]/impl/` 实现功能
   - 创建 `blocks/[domain]/[block]/index.ts` 统一导出

2. **进度记录**：
   - 每个关键步骤记录到 `dev-log/[session-id]/[timestamp].md`
   - 使用 `----` 分隔不同记录

### 3️⃣ AI自行验证

#### 必须原则
- ✅ 所有测试必须0失败
- ✅ 前端必须用 Playwright MCP 验证
- ✅ 验收标准必须满足
- ✅ 记录验证结果到 dev-log

#### 可选原则
- 💡 检查代码覆盖率
- 💡 性能基准测试
- 💡 安全漏洞扫描

**必须全部通过**：
- [ ] 单元测试通过（0失败）
- [ ] 集成测试通过（如有）
- [ ] 前端使用 Playwright MCP 验证（如为前端积木）
- [ ] 验收标准中的条件满足

### 4️⃣ 积木完成

#### 必须原则
- ✅ 先展示验证地址给用户
- ✅ 展示测试结果
- ✅ 等待用户确认后才提交
- ✅ 记录完成状态到 dev-log

#### 可选原则
- 💡 提供效果截图/录屏
- 💡 总结关键学习点
- 💡 建议后续优化
```markdown
## 📍 积木完成
🔍 **验证地址**：[具体链接/路径]
🧪 **测试结果**：
- 测试通过：X/X
- 覆盖率：XX%
📸 **效果展示**：[截图/录屏/日志]
```

### 5️⃣ 用户验证后

#### 必须原则
- ✅ 提交代码使用规范格式
- ✅ 更新 `docs/all-blocks.md` 登记
- ✅ 记录版本和时间信息

#### 可选原则
- 💡 创建发布说明
- 💡 通知下游依赖方
- 💡 更新相关文档

**执行步骤**：
- 提交代码：`git commit -m "task(blocks/[domain]/[block]): [动词+结果]"`
- 更新 `docs/all-blocks.md` 登记信息
- 记录完成时间和版本

---

## 🏗️ 积木代码结构

```
blocks/
└── [domain]/
    └── [block]/
        ├── contracts/     # 对外接口定义
        │   └── index.ts  # 接口、类型、DTO定义
        ├── impl/         # 实现代码
        │   └── index.ts  # 具体实现
        ├── tests/        # 测试代码
        │   ├── unit.test.ts
        │   └── integration.test.ts
        └── index.ts      # 统一导出（re-export）
```

---

## ⚙️ 强制规则

### 代码组织
1. **位置**：所有积木必须在 `blocks/` 目录下
2. **依赖**：只允许单向依赖（业务→契约→实现）
3. **导出**：只通过 `index.ts` 暴露公共接口
4. **规模**：单文件≤500行，单函数≤80行

### 开发要求
1. **契约优先**：先定义接口，再实现
2. **TDD强制**：必须先写测试
3. **即时验证**：每步完成立即运行测试
4. **防御编程**：校验外部输入，处理异步错误

### 记录要求
1. **dev-log**：记录所有关键决策和步骤
2. **提交信息**：`task(blocks/路径): 动作结果`
3. **积木登记**：完成后更新 `docs/all-blocks.md`

---

## 📝 积木登记模板

```markdown
## [block-id] - [block-name]
- Domain: `blocks/[domain]/[block]/`
- Summary: [一句话功能说明]
- Contracts: [导出接口列表]
- Dependencies: [依赖的其他积木ID]
- Version: v1.0.0
- Status: active
- Acceptance: [验收地址/命令]
- CreatedAt: YYYY-MM-DD
- LastVerifiedAt: YYYY-MM-DD
```

---

## 🎯 快速检查清单

开始前：
- [ ] 确认积木名称和目标
- [ ] 明确输入输出
- [ ] 设定验收标准和地址

执行中：
- [ ] 先写测试（TDD）
- [ ] 定义契约接口
- [ ] 实现功能
- [ ] 创建统一导出

验证时：
- [ ] 运行所有测试
- [ ] 前端用 Playwright 验证
- [ ] 检查验收标准

完成后：
- [ ] 展示验证结果
- [ ] 提交代码
- [ ] 更新积木登记

---

## 💡 最佳实践

1. **小步快跑**：每个积木保持最小化，可在1-2小时内完成
2. **清晰边界**：积木间通过契约通信，不直接引用实现
3. **持续验证**：每个改动后立即运行测试
4. **及时记录**：重要决策和问题实时写入 dev-log

---

## 🚫 禁止事项

- ❌ 在 `blocks/` 外创建积木代码
- ❌ 跨积木直接引用私有实现
- ❌ 循环依赖
- ❌ 跳过测试直接实现
- ❌ 修改已冻结的契约（需版本升级）
- ❌ 提交未经验证的代码

---

## 📊 Session 记录

每次开发会话需记录：
- Session ID：[自动生成]
- 模式选择：交互模式/全自动模式
- 积木列表：已完成/进行中/待开发
- 关键决策：技术选型/问题解决方案